
Cascade
-------
Software utility to manipulate touchstone s-parameter files.

Features
--------
The utility takes a touchstone file as standard input
and outputs a new touchstone file (or other formats)
to standard output.  Cascade provides the following
input transformations as command line options:

```
-cascade             : cascade the top two networks on the stack together
-deembed             : deembed the output of the top two networks on the stack
-ideembed            : deembed the input of the top two networks on the stack
-cbg                 : transform network on top of stack into a common-base arrangement.
-ccd                 : transform network on top of stack into a common-collector arrangement.
-series <ohms>       : push a series resistor onto the stack
-shunt <ohms>        : push a shunt resistor onto the stack
-lift <complex>      : lift top network from ground and inserts a complex impedance.
-lift <inductance>   : lift top network from ground and inserts an inductor.
-f <filename.s2p>    : push a network onto the stack
```

By default the utlitilty outputs a touchstone file with 
GUM and Rollet stability information as comments.  It can
also output the following alternative formats:

```
-n  : outputs the result of write_touchstone() from scikit-rf 
-a  : outputs the network as ABCD matrices
-z  : outputs S11 and S22 as impedances
```

Installation
------------
```
$ sudo pip install -r requirements.txt
$ sudo cp cascade.py /usr/local/bin/cascade
$ sudo chmod 755 /usr/local/bin/cascade
$ sh test.sh       # to run unit tests
```

Examples
--------

The pu flag means potentially unstable.

```
$ cascade < 2n5179_5ma.s2p 
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.471    0.00      6.78  180.00         0    0.00     0.844    0.00 !  23.1       inf    0.3975 
100       0.471  -90.00      6.78  122.00     0.023   64.00     0.844  -51.00 !  23.1    0.4623    0.2799 pu
200       0.314 -145.00       4.2  100.00     0.034   58.00      0.78  -93.00 !  17.0     1.109    0.1542 
300        0.23  156.00      2.76   91.00     0.043   65.00     0.768 -134.00 !  12.9     1.819    0.2728 
400       0.171  108.00      2.17   86.00     0.056   63.00     0.756 -177.00 !  10.5     1.874    0.2371 
500       0.168   54.00      1.86   79.00     0.062   62.00     0.741  140.00 !   9.0     1.883    0.1073 
600       0.149   -9.00      1.53   71.00     0.069   66.00      0.74   98.00 !   7.2     2.074   0.08789 
700       0.137  -72.00      1.31   67.00     0.073   71.00     0.739   54.00 !   5.9     2.469    0.1926 
800       0.119 -129.00      1.18   64.00     0.092   74.00     0.744    8.00 !   5.0     2.098    0.1526 
900       0.153 -174.00      1.13   58.00     0.101   68.00     0.742  -38.00 !   4.6     1.875   0.04344 
1000      0.171  122.00     0.979   49.00     0.106   71.00     0.749  -82.00 !   3.5     2.083    0.1502 
```

Display the result as ABCD matrices.

```
$ cascade -a < 2n5179_5ma.s2p 
! MHZ          A                 B                 C                 D
0       0.01692 -180.00        10 -180.00 0.0001217 -180.00   0.07194 -180.00
100     0.05534  -88.08     7.139 -166.65  0.001397  -51.43    0.1243 -120.34
200       0.107  -70.35     6.367 -148.80  0.004076  -59.44      0.17 -131.82
300      0.2218  -60.14     6.235 -130.84  0.007505  -77.69    0.1408 -149.65
400      0.3684  -72.05     4.008  -95.97  0.009134  -94.89   0.03424  -93.31
500      0.4608  -86.97     9.595  -33.46  0.008633 -105.44    0.1543  -28.46
600      0.4624 -105.15     22.05  -37.35  0.008063 -103.97    0.3211  -24.06
700      0.2943 -122.15     32.17  -54.24  0.006801 -106.18    0.5633  -33.08
800     0.06799  -81.22     36.07  -68.63   0.00344  -87.15    0.7668  -53.02
900       0.246    0.28        33  -77.79  0.006156  -18.70    0.8021  -71.03
1000     0.5662    4.77     33.48  -76.44   0.01307  -21.60    0.6974  -89.08
```

Display the result as the impedances of S11 and S22.

```
$ cascade -z < 2n5179_5ma.s2p 
! MHZ         Z11               Z22
0           139    0.00       591    0.00
100          50  -50.44     103.3  -77.63
200       30.09  -21.78     47.52  -75.89
300       32.77   11.17     22.18  -69.63
400        45.1   18.52      7.07  -10.46
500       60.73   15.63     19.63   64.67
600       67.24   -2.73     43.73   72.85
700       54.34  -14.87     94.41   69.21
800       43.09  -10.63     307.5   24.88
900        36.8   -1.88     133.6  -63.81
1000      41.85   16.63     57.19  -73.51
```

Shunt a 330 ohm resistor across the output of the two-port network.  This makes the transistor unconditionally stable.

```
$ cascade -shunt 330 -cascade < 2n5179_5ma.s2p 
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.471   -0.00     5.949  180.00 4.877e-18 -180.00     0.618   -0.00 !  18.7 8.289e+15    0.2911 
100      0.4695  -88.72     6.069  124.55   0.02059   66.55    0.6577  -53.05 !  19.2     1.557    0.2057 
200      0.3082 -143.49      3.91  103.15   0.03165   61.15    0.6784  -95.81 !  15.0     1.884    0.1468 
300      0.2213  155.91     2.664   93.31    0.0415   67.31    0.7377 -135.77 !  12.1     2.142    0.2583 
400      0.1643  105.92      2.13   86.17   0.05498   63.17    0.7603 -177.12 !  10.4     1.906    0.2271 
500      0.1675   51.12       1.8   77.00      0.06   60.00    0.7204  141.75 !   8.4     2.151    0.1077 
600       0.155  -10.66     1.431   68.02   0.06452   63.02    0.6532  101.19 !   5.6         3   0.06756 
700      0.1428  -70.78     1.181   64.66   0.06579   68.66    0.5781   57.14 !   3.3     4.307    0.1536 
800      0.1197 -125.52     1.043   63.60    0.0813   73.60    0.5415    8.59 !   1.9     4.169    0.1199 
900      0.1491 -171.48     1.008   59.77   0.09013   69.77    0.5603  -40.49 !   1.8     3.657   0.02895 
1000     0.1638  121.96    0.9022   51.97   0.09769   73.97     0.632  -85.31 !   1.4     3.358    0.1351 
```

Cascade a series 20 ohm resistor with the output of the two-port network.

```
$ cascade -series 20 -cascade < 2n5179_5ma.s2p 
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.471   -0.00     6.575  180.00 2.695e-18 -180.00    0.8487   -0.00 !  23.0 6.141e+15    0.3997 
100      0.4714  -93.44     6.155  115.16   0.02088   57.16    0.7407  -46.86 !  20.3     1.194    0.2787 
200      0.3248 -148.73     3.448   92.65   0.02791   50.65    0.5297  -82.32 !  12.7     3.225   0.08236 
300       0.248  155.65     2.105   86.17   0.03279   60.17    0.3788 -122.00 !   7.4     5.894    0.1364 
400       0.185  111.63     1.606   85.66   0.04145   62.66    0.2999 -175.86 !   4.7     6.681    0.1172 
500      0.1686   59.96     1.412   83.15   0.04708   66.15    0.3478  127.85 !   3.7      6.41   0.04192 
600      0.1339   -5.65     1.245   77.85   0.05613   72.85    0.4864   85.50 !   3.2      5.38   0.07833 
700      0.1236  -76.67      1.17   73.13   0.06521   77.13    0.6494   47.27 !   3.8      3.85    0.1566 
800      0.1201 -138.88     1.121   65.13   0.08738   75.13    0.7539    7.12 !   4.7     2.218     0.131 
900       0.163  179.31      1.04   53.18   0.09292   63.18    0.7004  -33.51 !   3.4     2.516   0.05619 
1000     0.1883  121.15    0.8238   41.83   0.08919   63.83    0.5533  -71.64 !   0.1     4.533   0.08788 
```

Lift terminal 3, the port connected to ground, and add a 10nH inductor.  Then cascade the result
with a shunt 100 ohm resistor to stabilize the result.

```
$ cascade -lift 10e-9 -shunt 100 -cascade < 2n5179_5ma.s2p 
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.471    0.00     4.641  180.00  1.49e-33   90.00    0.2621   -0.00 !  14.7 5.241e+31    0.1235 
100      0.2894  -31.98      3.67  112.81   0.03295  129.17    0.2602  -55.49 !  12.0     3.527    0.0679 
200      0.2813    0.15     2.299   91.42    0.1193  112.36    0.2716  -97.16 !   7.9     1.653    0.2441 
300      0.3553    4.07     1.669   75.50    0.2257   82.69    0.3018 -146.61 !   5.4     1.188    0.3348 
400      0.3673   -2.21     1.266   61.02    0.2619   55.24    0.2773  162.64 !   3.0     1.297    0.2681 
500      0.3933   -3.40    0.9646   51.78    0.2325   39.45    0.2338  118.67 !   0.7      1.81    0.1452 
600      0.3965  -14.35    0.7704   47.45     0.207   37.88    0.2079   80.31 !  -1.3      2.53   0.08616 
700       0.319  -21.21    0.6623   46.78    0.1807   37.44    0.2023   41.51 !  -2.9     3.631    0.1082 
800      0.2797   -3.83    0.5861   50.23    0.1252   54.88    0.2335    0.19 !  -4.0     5.997    0.1128 
900       0.375    0.32    0.6423   57.44    0.2209  100.88    0.3044  -46.80 !  -2.8     2.922    0.2501 
1000     0.4493  -17.00    0.8127   50.80    0.4842   83.82    0.3872 -103.62 !  -0.1     1.103    0.4691 
```

Transform the common emitter s-parameter input into a common-base.

```
$ cascade -cbg < 2n5179_5ma.s2p
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0        0.6692  180.00      1.55   -0.00    0.0258    0.00    0.9649   -0.00 !  18.0     1.141    0.6858 
100      0.7455  173.47     1.673  -11.49   0.08774   75.40     1.046  -10.87 !   inf   0.04985    0.8148 pu
200      0.7834  166.09     1.623  -22.23    0.1673   79.26     1.115  -27.69 !   inf   -0.1685    0.8752 pu
300       0.798  154.26      1.41  -32.60    0.3239   72.65     1.017  -53.92 !   inf   -0.1879    0.7071 pu
400      0.7442  144.59     1.256  -34.55     0.464   48.66    0.6954  -75.56 !   8.4    0.1916    0.5108 pu
500      0.7206  135.76     1.264  -36.70     0.528   27.09    0.3917  -83.59 !   5.9    0.5052    0.5892 pu
600      0.6681  125.60     1.315  -44.49    0.5151    3.26    0.1657  -65.59 !   5.1    0.7577    0.7076 pu
700      0.5996  116.64     1.338  -57.47    0.3734  -19.62    0.2935    7.81 !   4.9    0.9993    0.6664 pu
800      0.5371  109.65     1.212  -74.72    0.1278  -28.04    0.7227   -6.39 !   6.4     1.523    0.5318 
900      0.4694  105.01    0.9932  -93.71     0.209   81.20     1.083  -40.18 !   inf   -0.3312    0.5051 pu
1000      0.414   89.52    0.5058 -123.81    0.5353   63.17     1.108  -80.94 !   inf   -0.3771    0.4424 pu
```

Use scikit-rf to generate the touchstone file output.

```
$ cascade -cbg -n < 2n5179_5ma.s2p
! 2n5179
! Common Emitter S-Parameters, @ VCE = 6 V, IC = 5 mA
!
!Created with skrf (http://scikit-rf.org).
# MHz S MA R 50.0 
!freq magS11 angS11 magS21 angS21 magS12 angS12 magS22 angS22
0.0 0.6692426466074661 180.0 1.5502959165295256 -1.551465940202359e-15 0.02579907356461765 5.348475586809466e-15 0.9649230814893031 -1.944279766065974e-16
100.0 0.7455471780193107 173.4673245611077 1.672818085601664 -11.49380796531739 0.08773935968335025 75.39805198634349 1.0456815056589535 -10.867979725109645
200.0 0.7834430872862167 166.0895199876766 1.6229867140340934 -22.226124981350548 0.16733703476715375 79.2557607121151 1.1151755191288588 -27.685818848883926
300.0 0.7979925451769715 154.25697514762632 1.4095218202969544 -32.60436722163437 0.3238767729158846 72.6547434579701 1.0172320910206218 -53.91683274407587
400.0 0.7442309030558328 144.59252720182496 1.2563474089770132 -34.54849433371512 0.4639539709783672 48.65822771856141 0.6954374359615991 -75.55886428473526
500.0 0.7205715283360915 135.7604298020763 1.2643739682093142 -36.70133425168649 0.5279867165582515 27.091334546890508 0.3916927529939002 -83.59176502374389
600.0 0.6680796454011126 125.5983813446756 1.3153990149738912 -44.487943155903366 0.5151233782856354 3.2563783466125025 0.16567766703712808 -65.58556933802483
700.0 0.5996097701791779 116.6380673005609 1.3376661922119624 -57.47435990412244 0.3734121605885237 -19.61655771865781 0.293549168786818 7.8098673666891685
800.0 0.5371378734471894 109.64705082519507 1.2122982544257286 -74.71721613818976 0.12775900549058258 -28.036577424836473 0.7227416875970814 -6.386700421850614
900.0 0.4693545642663365 105.01157379901913 0.9931667929963139 -93.71451112390174 0.20899267833950771 81.20465259868146 1.0827113485407773 -40.18462091083251
1000.0 0.4139680565297178 89.51878611982566 0.505840972904608 -123.81398013942074 0.5353149151232665 63.166362381113075 1.1084319629796302 -80.93517128717015
```

Insert a one ohm resistor at the emitter to provide shunt feedback.

```
< 2n5179_5ma.s2p cascade -lift 1+0j
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.507   -0.00     6.308  180.00 0.0007679    0.00    0.8541   -0.00 !  23.0     21.18    0.4378 
100      0.5026  -82.33     6.453  124.47   0.03084   68.45    0.8719  -48.35 !  23.7    0.1972    0.3021 pu
200      0.3182 -135.30     4.084  101.58   0.04909   53.96    0.7981  -89.87 !  17.1    0.6767   0.09714 pu
300       0.207  163.41     2.689   91.88   0.05657   50.07    0.7621 -130.87 !  12.6     1.447     0.253 
400      0.1457  109.26     2.112   86.78   0.06327   47.44    0.7312 -174.12 !   9.9     1.872    0.2369 
500      0.1549   49.71     1.817   79.92   0.06313   48.98    0.7097  142.15 !   8.3     2.119    0.1174 
600      0.1538  -13.14     1.505   71.80    0.0672   56.96    0.7137   99.11 !   6.7     2.338   0.07735 
700      0.1477  -71.33     1.295   67.61   0.06973   65.17     0.724   54.26 !   5.6     2.716    0.1904 
800      0.1235 -123.93     1.171   64.46   0.09085   72.14    0.7409    7.85 !   4.9     2.168    0.1596 
900      0.1491 -169.65     1.126   58.22    0.1062   66.54    0.7445  -38.10 !   4.6     1.784   0.05541 
1000     0.1609  123.17    0.9781   48.86    0.1141   66.76    0.7477  -81.82 !   3.5     1.947    0.1402 
```

Create a cascode amplifier.

```
$ cascade -cbg < 2n5179_5ma.s2p > cb.s2p
$ cascade -f cb.s2p -cascade < 2n5179_5ma.s2p
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0        0.6692  180.00      1.55   -0.00    0.0258    0.00    0.9649   -0.00 !  18.0     1.141    0.6858 
100      0.7455  173.47     1.673  -11.49   0.08774   75.40     1.046  -10.87 !   inf   0.04985    0.8148 pu
200      0.7834  166.09     1.623  -22.23    0.1673   79.26     1.115  -27.69 !   inf   -0.1685    0.8752 pu
300       0.798  154.26      1.41  -32.60    0.3239   72.65     1.017  -53.92 !   inf   -0.1879    0.7071 pu
400      0.7442  144.59     1.256  -34.55     0.464   48.66    0.6954  -75.56 !   8.4    0.1916    0.5108 pu
500      0.7206  135.76     1.264  -36.70     0.528   27.09    0.3917  -83.59 !   5.9    0.5052    0.5892 pu
600      0.6681  125.60     1.315  -44.49    0.5151    3.26    0.1657  -65.59 !   5.1    0.7577    0.7076 pu
700      0.5996  116.64     1.338  -57.47    0.3734  -19.62    0.2935    7.81 !   4.9    0.9993    0.6664 pu
800      0.5371  109.65     1.212  -74.72    0.1278  -28.04    0.7227   -6.39 !   6.4     1.523    0.5318 
900      0.4694  105.01    0.9932  -93.71     0.209   81.20     1.083  -40.18 !   inf   -0.3312    0.5051 pu
1000      0.414   89.52    0.5058 -123.81    0.5353   63.17     1.108  -80.94 !   inf   -0.3771    0.4424 pu
```

Stabilize the cascode amp with a 100 ohm resistor across the output.  S12 is now significantly reduced compared to 
the unstabilized cascode as well as the CE amp.

```
 < 2n5179_5ma.s2p cascade -f cb.s2p -cascade -shunt 100 -cascade
# MHZ S MA R 50
! MHZ         S11               S21               S12               S22       ! GUM[dB]       K         D
0         0.471   -0.00     4.487  180.00 9.627e-19    0.00    0.3273    0.00 !  14.6 8.041e+16    0.1542 
100      0.4465  -80.38     5.168  133.55 0.0009194  162.44    0.3832   -9.59 !  15.9     71.73    0.1668 
200      0.2298 -130.26     4.346  117.98  0.003626  177.47    0.4864  -26.26 !  14.2     22.95    0.1134 
300     0.05872  112.41     5.397   99.27   0.01931  178.52    0.7909  -55.60 !  18.9     1.877    0.1426 
400     0.06053 -154.28     4.008   28.13   0.03821   88.34    0.6741 -142.93 !  14.7     1.828    0.1331 
500     0.08392   38.87     1.748   12.32   0.02434   59.11     0.231  170.60 !   5.1     11.08   0.05842 
600      0.1474  -31.25     1.078   11.43   0.01904   54.18   0.05164   90.05 !   0.8     23.77     0.013 
700       0.176  -79.49    0.8808   12.91    0.0137   54.76    0.1107  -13.32 !  -0.9     39.69   0.03112 
800      0.1624 -119.61    0.8056    7.62  0.006623   64.30    0.2294  -21.30 !  -1.5     86.48   0.04184 
900      0.1815 -156.44    0.8088   -7.88   0.01521  177.03    0.5032  -43.32 !  -0.4     29.27   0.07917 
1000     0.1758  145.27     0.558  -56.91   0.06394  152.07    0.7856  -91.95 !  -0.8     5.114     0.114 
```


